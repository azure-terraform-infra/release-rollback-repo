name: Release Workflow
on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g. v1.2.3)'
        required: true
        type: string

env:
  VERSION: ${{ github.event.inputs.version }}
  REGISTRY: "ghcr.io/dolvladzio"
  ORG: "dolvladzio"
  REPOS: "app-1 app-2 app-3"
  PAT: ${{ secrets.PAT }}

jobs:
    create-release-tag:
      runs-on: ubuntu-latest
      steps:
        - name: Checkout code
          uses: actions/checkout@v4

        - name: Login to registry
          run: |
            echo "${{ env.PAT }}" | \
              docker login ghcr.io -u ${{ github.actor }} --password-stdin

        - name: Create tags and releases in repos
          run: |
            for repo in ${{ env.REPOS}}; do
              echo "Processing $repo with version ${{ env.VERSION }}"

              # 1️⃣ Find default branch sha
              BRANCH=$(curl -s -H "Authorization: token ${{ env.PAT }}" \
                "https://api.github.com/repos/${{ env.ORG }}/$repo" | jq -r .default_branch)
              SHA=$(curl -s -H "Authorization: token ${{ env.PAT }}" \
                "https://api.github.com/repos/${{ env.ORG }}/$repo/git/refs/heads/$BRANCH" | jq -r .object.sha)

              # 2️⃣ Create tag (ignore if exists)
              curl -sS -X POST -H "Authorization: token ${{ env.PAT }}" \
                -d "{\"ref\":\"refs/tags/${{ env.VERSION }}\",\"sha\":\"${SHA}\"}" \
                "https://api.github.com/repos/${{ env.ORG }}/$repo/git/refs" || echo "Tag exists or error"

              # 3️⃣ Create release (ignore if exists)
              curl -sS -X POST -H "Authorization: token ${{ env.PAT }}" \
                -H "Accept: application/vnd.github+json" \
                "https://api.github.com/repos/${{ env.ORG }}/$repo/releases" \
                -d "{
                      \"tag_name\": \"${{ env.VERSION }}\",
                      \"name\": \"Release ${{ env.VERSION }}\",
                      \"body\": \"Automated release for version ${{ env.VERSION }}\",
                      \"draft\": false,
                      \"prerelease\": false
                    }" || echo "Release exists or error"
            done

        - name: Wait for all images to be available
          run: |
            sleep 30  # initial wait before checking
            echo "⏳Checking images"

            for i in ${{ env.REPOS}}; do
              IMAGE="${{ env.REGISTRY }}/$i:${{ env.VERSION }}"
              echo "Waiting for $IMAGE ..."

              # retry logic: 30 attempts x 5 sec = 150 sec max wait
              for attempt in {1..30}; do
                if docker manifest inspect "$IMAGE" > /dev/null 2>&1; then
                  echo "✅ Found $IMAGE"
                  break
                fi

                echo "Not yet available, retry $attempt/30..."
                sleep 5
              done

              # if not found after retries → fail
              if ! docker manifest inspect "$IMAGE" > /dev/null 2>&1; then
                echo "❌ $IMAGE NOT found after waiting"
                exit 1
              fi
            done

            echo "✅ All images are available!"

    deploy-release:
      needs: create-release-tag
      runs-on: ubuntu-latest
      steps:
        - name: Checkout code
          uses: actions/checkout@v4

        - name: Success!
          run: echo "✅Release - ${{ github.event.inputs.version }} deployed to all repositories."