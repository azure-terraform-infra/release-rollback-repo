name: Release Workflow
on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g. v1.2.3)'
        required: true
        type: string

env:
  VERSION: ${{ github.event.inputs.version }}

jobs:
    create-release-tag:
      runs-on: ubuntu-latest
      steps:
        - name: Checkout code
          uses: actions/checkout@v4

        - name: Login to registry
          run: |
            echo "${{ secrets.PAT }}" | \
              docker login ghcr.io -u ${{ github.actor }} --password-stdin

        - name: Create tags and releases in repos
          env:
            ORG: dolvladzio
            REPOS: "app-1 app-2 app-3"
            PAT: ${{ secrets.PAT }}
          run: |
            for repo in $REPOS; do
              echo "Processing $repo with version $VERSION"

              # 1️⃣ Find default branch sha
              BRANCH=$(curl -s -H "Authorization: token $PAT" \
                "https://api.github.com/repos/$ORG/$repo" | jq -r .default_branch)
              SHA=$(curl -s -H "Authorization: token $PAT" \
                "https://api.github.com/repos/$ORG/$repo/git/refs/heads/$BRANCH" | jq -r .object.sha)

              # 2️⃣ Create tag (ignore if exists)
              curl -sS -X POST -H "Authorization: token $PAT" \
                -d "{\"ref\":\"refs/tags/${VERSION}\",\"sha\":\"${SHA}\"}" \
                "https://api.github.com/repos/$ORG/$repo/git/refs" || echo "Tag exists or error"

              # 3️⃣ Create release (ignore if exists)
              curl -sS -X POST -H "Authorization: token $PAT" \
                -H "Accept: application/vnd.github+json" \
                "https://api.github.com/repos/$ORG/$repo/releases" \
                -d "{
                      \"tag_name\": \"${VERSION}\",
                      \"name\": \"Release ${VERSION}\",
                      \"body\": \"Automated release for version ${VERSION}\",
                      \"draft\": false,
                      \"prerelease\": false
                    }" || echo "Release exists or error"
            done

        - name: Check if images have been pushed successfully
          env:
            REGISTRY: ghcr.io/dolvladzio
            IMAGES: "app-1 app-2 app-3"
            TIMEOUT: 300
            INTERVAL: 10
          run: |
            sleep 15  # Initial wait before checking
            for image in "${IMAGES[@]}"; do
              echo "Checking $REGISTRY/$image:$VERSION"
              ELAPSED=0
              while [ $ELAPSED -lt $TIMEOUT ]; do
                if docker manifest inspect "$REGISTRY/$image:$VERSION" > /dev/null 2>&1; then
                  echo "✅ Found $REGISTRY/$image:$VERSION"
                  break
                fi
                echo "Waiting for $REGISTRY/$image:$VERSION ..."
                sleep $INTERVAL
                ELAPSED=$((ELAPSED + INTERVAL))
              done
              if [ $ELAPSED -ge $TIMEOUT ]; then
                echo "❌ Timeout waiting for $REGISTRY/$image:$VERSION"
                exit 1
              fi
            done

            echo "✅All images exist!"

    deploy-release:
      needs: create-release-tag
      runs-on: ubuntu-latest
      steps:
        - name: Checkout code
          uses: actions/checkout@v4

        - name: Success!
          run: echo "✅Release - ${{ github.event.inputs.version }} deployed to all repositories."